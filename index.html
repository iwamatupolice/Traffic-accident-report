<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>岩松県警察｜交通事故報告書（人身／物件）</title>
<style>
  :root{--bg:#0b1020;--card:#11182d;--ink:#e7ecff;--muted:#b8c0de;--border:#203058}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Meiryo",sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:1.35rem}
  .badge{background:linear-gradient(90deg,#3556a8,#2b3f7a);padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;color:#dfe7ff}
  .pill{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:.8rem;color:#c8d3ff}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin:16px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .g-12{grid-column:span 12}.g-9{grid-column:span 9}.g-8{grid-column:span 8}.g-6{grid-column:span 6}.g-4{grid-column:span 4}.g-3{grid-column:span 3}
  label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="datetime-local"],input[type="number"],select,textarea{
    width:100%;box-sizing:border-box;background:#0c1326;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:.95rem}
  textarea{min-height:120px;resize:vertical}
  .tall{min-height:200px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .btns{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{background:#1a2547;color:#eaf0ff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#4b77ff,#315bdf)}
  button.ok{background:#06361e;border-color:#0c6a3a}
  button.warn{background:#3a2a00;border-color:#5e4700}
  .hr{height:1px;background:var(--border);margin:8px 0}
  .drop{border:1px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:#cfe}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px}
  .thumb{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0c1326}
  .thumb img{display:block;width:100%;height:120px;object-fit:cover;background:#000}
  .thumb .cap{padding:8px}
  .thumb .tools{display:flex;gap:6px;justify-content:space-between;padding:8px}
  .thumb button{padding:6px 8px;border-radius:8px;font-size:.8rem}
  @media print{
    body{background:#fff;color:#000}.card{border:1px solid #000;background:#fff;color:#000}
    input,select,textarea{border:1px solid #000;background:#fff;color:#000}.pill{border-color:#000;color:#000}.hr{background:#000}
    .no-print{display:none!important}
  }
  .export-light{background:#fff !important;color:#000 !important}
  .export-light *{color:#000 !important;border-color:#000 !important}
  .export-light .card{background:#fff !important;border:1px solid #000 !important}
  .export-light .hr{background:#000 !important}
  .export-light input,.export-light select,.export-light textarea{background:#fff !important;color:#000 !important;border:1px solid #000 !important}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="row">
      <h1>交通事故報告書（人身／物件）</h1>
      <span id="docId" class="pill">ID: —</span>
    </div>
    <span class="badge">岩松県警察 / 入力支援フォーム</span>
  </div>

  <div class="card">
    <div class="grid">
      <div class="g-3"><label>報告書種別</label>
        <select id="reportType">
          <option value="injury">人身交通事故報告書</option>
          <option value="property">物件交通事故報告書</option>
        </select>
      </div>
      <div class="g-3"><label>所属氏名</label><input id="affName" placeholder="例：響野署 交通課／岩松 太郎"></div>
      <div class="g-3"><label>見　分　官</label><input id="inspector"></div>
      <div class="g-3"><label>補　助　者</label><input id="assistant"></div>

      <div class="g-3"><label>通報時間</label><input id="tReport" type="datetime-local"></div>
      <div class="g-3"><label>見分開始</label><input id="tStart" type="datetime-local"></div>
      <div class="g-3"><label>見分終了</label><input id="tEnd" type="datetime-local"></div>
      <div class="g-3"><label>発生時間</label><input id="tOccur" type="datetime-local"></div>

      <div class="g-9"><label>発生場所</label><input id="place" placeholder="例：響野市中央1丁目 県道12号×市道3号 北東角"></div>
      <div class="g-3"><label>道路種別</label>
        <select id="roadType">
          <option value="">（選択）</option><option>国道</option><option>県道</option><option>市道</option><option>町道</option><option>高速</option><option>その他</option>
        </select>
      </div>

      <div class="g-6"><label>事故形態</label>
        <div class="row" style="gap:8px">
          <select id="accType">
            <option value="">（選択）</option>
            <option>追突</option><option>出会い頭</option><option>右直</option><option>側面</option>
            <option>単独</option><option>追越し</option><option>車線変更</option><option>後退</option>
            <option>ドア開放</option><option>踏切</option><option>歩行者関与</option><option>自転車関与</option>
            <option>当て逃げ</option><option>その他</option>
          </select>
          <input id="accTypeOther" placeholder="その他の具体（任意）" style="display:none;flex:1 1 220px">
        </div>
      </div>
      <div class="g-6"><label>事故状況</label><textarea id="accDetail" class="tall" placeholder="簡潔に記載"></textarea></div>
    </div>
  </div>

  <!-- 人身：負傷者 -->
  <div class="card" id="injuryBlock">
    <div class="grid">
      <div class="g-12"><strong>【負傷者】</strong></div>
      <div class="g-6">
        <label>１．第  当事者の［運転手・同乗者（　に乗車）］</label>
        <div class="row" style="gap:8px">
          <select id="inj1_role"><option>運転手</option><option>同乗者</option></select>
          <input id="inj1_seat" placeholder="同乗者の場合：前席／後席右 など" />
        </div>
        <label style="margin-top:8px">怪我の程度</label>
        <input id="inj1_degree" placeholder="例：打撲（歩行可能） 等">
      </div>
      <div class="g-6">
        <label>２．第一  当事者</label>
        <label style="margin-top:8px">怪我の程度</label>
        <input id="inj2_degree" placeholder="例：頚部痛 訴え 等">
      </div>
    </div>
  </div>

  <!-- 当事者（共通） -->
  <div class="card">
    <div class="grid">
      <div class="g-12"><strong>【第一当事者】</strong></div>
      <div class="g-6"><label>氏　　名</label><input id="a_name"></div>
      <div class="g-3"><label>年　　齢</label><input id="a_age" type="number" min="0" inputmode="numeric"></div>
      <div class="g-3"><label>住　　所</label><input id="a_addr" placeholder="市区町村〜番地"></div>

      <div class="g-4" id="a_type_wrap" style="display:none"><label>種　　別（物件用）</label><input id="a_type" placeholder="例：歩行者／自転車／施設 など"></div>
      <div class="g-4"><label>同乗者名</label><input id="a_pass"></div>
      <div class="g-4"><label>車　　名</label><input id="a_car"></div>

      <div class="g-4"><label>破損状況</label><input id="a_damage"></div>
      <div class="g-8"><label id="a_stmt_label">供述調書（人身）／申し立て（物件）</label><textarea id="a_stmt"></textarea></div>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="g-12"><strong>【第二当事者】</strong></div>
      <div class="g-6"><label>氏　　名</label><input id="b_name"></div>
      <div class="g-3"><label>年　　齢</label><input id="b_age" type="number" min="0" inputmode="numeric"></div>
      <div class="g-3"><label>住　　所</label><input id="b_addr" placeholder="市区町村〜番地"></div>

      <div class="g-4" id="b_type_wrap" style="display:none"><label>種　　別（物件用）</label><input id="b_type"></div>
      <div class="g-4"><label>同乗者名</label><input id="b_pass"></div>
      <div class="g-4"><label>車　　名</label><input id="b_car"></div>

      <div class="g-4"><label>破損状況</label><input id="b_damage"></div>
      <div class="g-8"><label id="b_stmt_label">供述調書（人身）／申し立て（物件）</label><textarea id="b_stmt"></textarea></div>
    </div>
  </div>

  <!-- 実況見分調書 文章（人身のみ） -->
  <div class="card" id="jikkouNote">
    <div class="grid">
      <div class="g-12"><strong>【実況見分調書】</strong></div>
      <div class="g-12">
        <textarea id="jikkou" class="tall" placeholder="本件交通事故の状況を明らかにするため、本職が撮影した写真　枚及び見分結果の図面を添付する。"></textarea>
      </div>
    </div>
  </div>

  <!-- 画像添付 -->
  <div class="card">
    <div class="grid">
      <div class="g-12"><label>写真・資料（PNG出力に転記）</label>
        <div id="drop" class="drop">ここに画像をドラッグ＆ドロップ（または下のボタン）</div>
        <div class="row" style="margin-top:8px">
          <input id="fileInput" type="file" accept="image/*" multiple>
          <button id="clearImages" class="warn">全部消す</button>
        </div>
        <div id="thumbs" class="thumbs"></div>
      </div>
    </div>
  </div>

  <!-- 操作 -->
  <div class="card no-print">
    <div class="btns">
      <button class="primary" id="btnPreview">プレビュー/印刷</button>
      <button class="ok" id="btnSave">下書きを保存</button>
      <button id="btnLoad">下書きを読込</button>
      <button id="btnJSON">JSONを書き出し</button>
      <button id="btnMD">Markdownをコピー</button>
      <button id="btnPNG">PNGを書き出し</button>
    </div>
  </div>

  <!-- プレビュー -->
  <div class="card" id="preview" style="display:none">
    <div id="previewBody"></div>
  </div>
</div>

<script>
  const $ = (q)=>document.querySelector(q);
  const FIELDS = [
    'reportType','affName','inspector','assistant','tReport','tStart','tEnd','tOccur','place','roadType','accType','accTypeOther','accDetail',
    'inj1_role','inj1_seat','inj1_degree','inj2_degree',
    'a_name','a_age','a_addr','a_type','a_pass','a_car','a_damage','a_stmt',
    'b_name','b_age','b_addr','b_type','b_pass','b_car','b_damage','b_stmt',
    'jikkou'
  ];
  const LSKEY='iwamatsu_accident_report_v2';
  const IMGKEY='iwamatsu_accident_images_v1';
  let images=[];

  function genId(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `IW-${String(d.getFullYear()).slice(-2)}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;}
  function setDocId(){ $('#docId').textContent='ID: '+genId(); }
  function formatDT(s){ if(!s) return ''; return String(s).replace('T',' ').replace(/:\d\d$/,''); }
  function esc(s){ return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function nl2br(s){ return String(s||'').replace(/\n/g,'<br>'); }

  // 事故形態：その他入力欄の表示切替
  function toggleAccOther(){
    const v = $('#accType').value;
    $('#accTypeOther').style.display = (v==='その他') ? 'block' : 'none';
  }

  function toObj(){
    const o={}; FIELDS.forEach(k=>{ const el=$('#'+k); o[k]=el?.value??''; });
    // 事故形態は「その他」が選ばれていれば free text を優先
    o.accTypeFinal = (o.accType==='その他' && o.accTypeOther) ? o.accTypeOther : (o.accType || '');
    o.docId=$('#docId').textContent.replace('ID: ',''); o.images=images;
    return o;
  }
  function applyObj(o){
    FIELDS.forEach(k=>{ if($('#'+k)) $('#'+k).value=o[k]??''; });
    images=Array.isArray(o.images)?o.images:[];
    toggleByType(); toggleAccOther(); renderThumbs();
  }
  function saveDraft(){ localStorage.setItem(LSKEY, JSON.stringify(toObj())); alert('下書きを保存しました'); }
  function loadDraft(){ const raw=localStorage.getItem(LSKEY); if(!raw) return alert('保存はありません'); const o=JSON.parse(raw); applyObj(o); $('#docId').textContent='ID: '+(o.docId||genId()); alert('読み込みました'); }
  function exportJSON(){ const o=toObj(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(o,null,2)],{type:'application/json'})); a.download=`${o.docId}.json`; a.click(); URL.revokeObjectURL(a.href); }

  function toMarkdown(o){
    const type = o.reportType==='property' ? '物件交通事故報告書' : '人身交通事故報告書';
    const baseTop =
      `${type}（${o.docId}）\n\n`+
      `所属氏名：${o.affName||''}\n見  分  官：${o.inspector||''}\n補  助  者：${o.assistant||''}\n\n`+
      `通報時間：${formatDT(o.tReport)}\n見分開始：${formatDT(o.tStart)}\n見分終了：${formatDT(o.tEnd)}\n発生時間：${formatDT(o.tOccur)}\n`+
      `発生場所：${o.place||''}\n道路種別：${o.roadType||''}\n事故形態：${o.accTypeFinal||''}\n事故状況：${o.accDetail||''}\n\n`;

    const partyA =
      `【第一当事者】\n氏　　名：${o.a_name||''}\n年　　齢：${o.a_age||''}\n住　　所：${o.a_addr||''}\n`+
      (o.reportType==='property' ? `種　　別：${o.a_type||''}\n` : '')+
      `同乗者名：${o.a_pass||''}\n車　　名：${o.a_car||''}\n破損状況：${o.a_damage||''}\n`+
      (o.reportType==='property' ? `申し立て：${o.a_stmt||''}\n` : `供述調書：${o.a_stmt||''}\n`);

    const partyB =
      `【第二当事者】\n氏　　名：${o.b_name||''}\n年　　齢：${o.b_age||''}\n住　　所：${o.b_addr||''}\n`+
      (o.reportType==='property' ? `種　　別：${o.b_type||''}\n` : '')+
      `同乗者名：${o.b_pass||''}\n車　　名：${o.b_car||''}\n破損状況：${o.b_damage||''}\n`+
      (o.reportType==='property' ? `申し立て：${o.b_stmt||''}\n` : `供述調書：${o.b_stmt||''}\n`);

    const injBlock = (o.reportType==='property') ? '' :
      `【負傷者】\n１．第　当事者［${o.inj1_role||''}${o.inj1_role==='同乗者' ? '（'+(o.inj1_seat||'')+' に乗車）' : ''}］\n`+
      `　怪我の程度（${o.inj1_degree||''}）\n２．第一　当事者\n　怪我の程度（${o.inj2_degree||''}）\n\n`+
      `【実況見分調書】\n${o.jikkou||'本件交通事故の状況を明らかにするため、本職が撮影した写真　枚及び見分結果の図面を添付する。'}\n`;

    return `# ${baseTop}${injBlock}${partyA}\n${partyB}`;
  }
  async function copyMD(){ const md=toMarkdown(toObj()); try{ await navigator.clipboard.writeText(md); alert('Markdownをコピーしました'); }catch{ alert('コピーできませんでした'); } }

  function renderPreview(o){
    const imgHtml=(o.images||[]).map((im,i)=>`
      <div style="break-inside:avoid; margin:0 0 12px 0; border:1px solid #666; border-radius:8px; overflow:hidden;">
        <div style="padding:6px 10px; font-weight:600">画像${i+1}：${esc(im.name||'image')}</div>
        <img src="${im.src}" style="display:block;width:100%;max-height:420px;object-fit:contain;background:#000">
      </div>
    `).join('');
    const typeName = o.reportType==='property'?'物件交通事故報告書':'人身交通事故報告書';
    const h = `
      <div class="grid">
        <div class="g-12"><strong>ID: ${esc(o.docId)}</strong>　${typeName}</div>
        <div class="g-12">所属氏名：${esc(o.affName)}／見 分 官：${esc(o.inspector)}／補 助 者：${esc(o.assistant)}</div>
        <div class="g-12">通報：${esc(formatDT(o.tReport))}　見分：${esc(formatDT(o.tStart))}〜${esc(formatDT(o.tEnd))}　発生：${esc(formatDT(o.tOccur))}</div>
        <div class="g-12">場所：${esc(o.place)}　道路：${esc(o.roadType)}　形態：${esc(o.accTypeFinal)}</div>
        <div class="g-12">事故状況：${nl2br(esc(o.accDetail))}</div>
        ${ o.reportType==='property' ? '' : `
          <div class="g-12"><strong>【負傷者】</strong>　１．第 当事者［${esc(o.inj1_role)}${o.inj1_role==='同乗者'?'（'+esc(o.inj1_seat)+' に乗車）':''}］／怪我：${esc(o.inj1_degree)}　｜　２．第一 当事者／怪我：${esc(o.inj2_degree)}</div>
          <div class="g-12"><strong>【実況見分調書】</strong><br>${nl2br(esc(o.jikkou||'本件交通事故の状況を明らかにするため、本職が撮影した写真　枚及び見分結果の図面を添付する。'))}</div>
        `}
        <div class="g-12"><strong>【第一当事者】</strong>　氏名：${esc(o.a_name)}／年齢：${esc(o.a_age)}／住所：${esc(o.a_addr)}／${o.reportType==='property' ? '種別：'+esc(o.a_type)+'／' : ''}同乗者：${esc(o.a_pass)}／車名：${esc(o.a_car)}／破損：${esc(o.a_damage)}／${o.reportType==='property' ? '申し立て' : '供述'}：${esc(o.a_stmt)}</div>
        <div class="g-12"><strong>【第二当事者】</strong>　氏名：${esc(o.b_name)}／年齢：${esc(o.b_age)}／住所：${esc(o.b_addr)}／${o.reportType==='property' ? '種別：'+esc(o.b_type)+'／' : ''}同乗者：${esc(o.b_pass)}／車名：${esc(o.b_car)}／破損：${esc(o.b_damage)}／${o.reportType==='property' ? '申し立て' : '供述'}：${esc(o.b_stmt)}</div>
        <div class="g-12"><strong>画像</strong></div>
        <div class="g-12">${imgHtml || '<span class="help">（画像なし）</span>'}</div>
      </div>`;
    $('#previewBody').innerHTML=h; $('#preview').style.display='block'; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  }

  // 画像
  const drop=$('#drop'), fileInput=$('#fileInput'), thumbs=$('#thumbs');
  function renderThumbs(){
    thumbs.innerHTML='';
    images.forEach((im,idx)=>{
      const d=document.createElement('div'); d.className='thumb';
      d.innerHTML=`<img src="${im.src}"><div class="cap"><input type="text" placeholder="キャプション（任意）" value="${(im.caption||'').replace(/"/g,'&quot;')}"></div>
      <div class="tools"><div class="row"><button data-a="up">↑</button><button data-a="down">↓</button><button data-a="del" class="warn">削除</button></div></div>`;
      d.querySelector('input').addEventListener('change',e=>{ images[idx].caption=e.target.value; persistImages(); });
      d.querySelector('[data-a="up"]').addEventListener('click',()=>{ if(idx===0)return; [images[idx-1],images[idx]]=[images[idx],images[idx-1]]; persistImages(); renderThumbs(); });
      d.querySelector('[data-a="down"]').addEventListener('click',()=>{ if(idx===images.length-1)return; [images[idx+1],images[idx]]=[images[idx],images[idx+1]]; persistImages(); renderThumbs(); });
      d.querySelector('[data-a="del"]').addEventListener('click',()=>{ images.splice(idx,1); persistImages(); renderThumbs(); });
      thumbs.appendChild(d);
    });
  }
  function persistImages(){ localStorage.setItem(IMGKEY, JSON.stringify(images)); }
  function loadImages(){ try{ const arr=JSON.parse(localStorage.getItem(IMGKEY)||'[]'); if(Array.isArray(arr)) images=arr; }catch{} }
  function resizeToDataURL(file,maxEdge){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>{ const img=new Image(); img.onload=()=>{
        const w=img.width, h=img.height, sc=Math.min(1, maxEdge/Math.max(w,h));
        const nw=Math.round(w*sc), nh=Math.round(h*sc);
        const cv=document.createElement('canvas'); cv.width=nw; cv.height=nh;
        cv.getContext('2d').drawImage(img,0,0,nw,nh);
        res(cv.toDataURL('image/jpeg',0.9));
      }; img.onerror=rej; img.src=fr.result; }; fr.onerror=rej; fr.readAsDataURL(file);
    });
  }
  ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='rgba(80,120,255,.1)';}));
  ['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.background='transparent';}));
  drop.addEventListener('drop', e=>{ e.preventDefault(); const fs=[...(e.dataTransfer?.files||[])].filter(f=>f.type.startsWith('image/')); fs.forEach(async f=>{ const d=await resizeToDataURL(f,1600); images.push({src:d,name:f.name,caption:''}); persistImages(); renderThumbs(); }); });
  fileInput.addEventListener('change', e=>{ const fs=[...(e.target.files||[])].filter(f=>f.type.startsWith('image/')); fs.forEach(async f=>{ const d=await resizeToDataURL(f,1600); images.push({src:d,name:f.name,caption:''}); persistImages(); renderThumbs(); }); fileInput.value=''; });
  $('#clearImages').addEventListener('click',()=>{ if(!confirm('画像をすべて削除しますか？')) return; images=[]; persistImages(); renderThumbs(); });

  // 出力
  async function exportPNG(){
    if($('#preview').style.display==='none'){ alert('先にプレビューしてください'); return; }
    document.body.classList.add('export-light'); await new Promise(r=>requestAnimationFrame(r));
    const canvas=await html2canvas($('#previewBody'),{scale:2,backgroundColor:'#ffffff',useCORS:true});
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download=`${$('#docId').textContent.replace('ID: ','')}.png`; a.click();
    document.body.classList.remove('export-light');
  }

  // 種別切替
  function toggleByType(){
    const t=$('#reportType').value;
    $('#injuryBlock').style.display = (t==='injury')?'block':'none';
    $('#a_type_wrap').style.display = (t==='property')?'block':'none';
    $('#b_type_wrap').style.display = (t==='property')?'block':'none';
    $('#a_stmt_label').textContent = t==='property' ? '申し立て（物件）' : '供述調書（人身）';
    $('#b_stmt_label').textContent = t==='property' ? '申し立て（物件）' : '供述調書（人身）';
    $('#jikkouNote').style.display = (t==='injury')?'block':'none';
  }

  // イベント
  $('#btnPreview').addEventListener('click',()=>renderPreview(toObj()));
  $('#btnSave').addEventListener('click',saveDraft);
  $('#btnLoad').addEventListener('click',loadDraft);
  $('#btnJSON').addEventListener('click',exportJSON);
  $('#btnMD').addEventListener('click',copyMD);
  $('#btnPNG').addEventListener('click',exportPNG);
  $('#reportType').addEventListener('change',toggleByType);
  $('#accType').addEventListener('change',toggleAccOther);

  // 初期化
  function initId(){ $('#docId').textContent='ID: '+genId(); }
  function setDocId(){ initId(); }
  setDocId(); toggleByType(); toggleAccOther();
  loadImages(); renderThumbs();
</script>
</body>
</html>
